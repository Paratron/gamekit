/* Gamekit
 * =======
 * @license: CC BY-NC 3.0 (http://creativecommons.org/licenses/by-nc/3.0/)
 * @license: Request commercial licenses from hello@wearekiss.com
 * @author: Christian Engel <hello@wearekiss.com>
 * @updated: Sun May 04 2014
 */
!function(){"use strict";function a(){this.entities=[],this.visible=!0,this.alpha=1,this._core=g}function b(a,b){for(b-=90;0>b;)b+=360;for(;b>360;)b-=360;var c,d;return c=Math.floor(a*Math.cos(b*Math.PI/180)),d=Math.floor(a*Math.sin(b*Math.PI/180)),[c,d]}function c(){function a(a,b){var c,d,e;if(c=n[a.keyCode],c&&(e=m[c],m[c]=b,void 0!==k[c]))for(d in k[c])b?e||k[c][d].resolve():e&&k[c][d].reject()}i||(k={},m={},window.onkeydown=function(b){a(b,!0)},window.onkeyup=function(b){a(b,!1)},i=!0)}function d(a){var b,c;c=a.getCanvas(),j||(j=!0,b=document.createElement("canvas"),b.width=c.width,b.height=c.height,o=b.getContext("2d"),o.globalCompositeOperation="copy",o.fillStyle="#f00",g.pointers=[],c.onmousedown=function(b){p&&e(a,b,"pointerdown")},c.onmouseup=function(b){q&&e(a,b,"pointerup")},c.onmousemove=function(b){r&&e(a,b,"pointermove")},c.ontouchstart=function(b){p&&e(a,b,"pointerdown")},c.ontouchend=function(b){q&&e(a,b,"pointerdown")},c.ontouchmove=function(b){r&&e(a,b,"pointermove")})}function e(a,b,c){var d,e,f,h,i,j,k,l;if(l=a.getCanvas(),d=b.clientX-l.offsetLeft+window.scrollX,e=b.clientY-l.offsetTop+window.scrollY,g.pointers.length||g.pointers.push({x:0,y:0}),g.pointers[0].x=d,g.pointers[0].y=e,a.isRunning)for(f=g.layer.length-1,k=f+1;k--;)if(h=g.layer[f-k],h.visible)for(i=h.entities.length-1,j=i+1;j--;)b=h.entities[i-j],b.disabled||b.shadowDraw(d,e,c)}function f(a,b){var c;return c=o.getImageData(a,b,1,1).data,c[0]||c[1]||c[2]||c[3]?!0:!1}var g;!function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),window.gamekit=g={},g.Core=function(){function a(d){var n,o,p,q,r,s,t,u,v;if(r=f.layer,u=f.camera.x,v=f.camera.y,b){for(window.requestAnimationFrame(a),f.lastRunTime=c=d,g(e),(l||m)&&e.clearRect(j,k,l,m),n=i.length;n--;)o=i[n],o.finished?i.splice(n,1):o.update(d);for(s=r.length-1,n=s+1;n--;)if(q=r[s-n],q.visible&&q.alpha)for(t=q.entities.length-1,o=t+1;o--;)p=q.entities[t-o],p.alpha<0&&(p.alpha=0),p._destroy?(q.entities.splice(t-o,1),t--):(e.globalAlpha=p.alpha*q.alpha,p.update(),p.x-=u,p.y-=v,p.draw(e),p.x+=u,p.y+=v);h(e)}}var b,c,d,e,f,g,h,i;f=this,d=document.getElementsByTagName("canvas")[0],e=d.getContext("2d"),i=[],this.isRunning=!1,this.layer=[],this.getLastRuntime=function(){return c},this.useCanvas=function(a){return"string"==typeof a?("#"===a[0]&&(a=a.substr(1)),d=document.getElementById(a),e=d.getContext("2d"),this):(d=a,e=d.getContext("2d"),this)},this.start=function(){return this.isRunning=b=!0,window.requestAnimationFrame(a),this},this.stop=function(){return this.isRunning=b=!1,this},this.width=function(a){return a&&(d.width=a),d.width},this.height=function(a){return a&&(d.height=a),d.height},this.addTween=function(a){i.push(a)},this.camera={x:0,y:0},g=function(){},this.setOnBeforeFrame=function(a){return g=a,this},h=function(){},this.setOnAfterFrame=function(a){return h=a,this};var j,k,l,m;this.clearCanvas=function(a,b,c,d){return j=a||0,k=b||0,l=c||this.width(),m=d||this.height(),this},this.getCanvas=function(){return d},this.getCTX=function(){return e}},g.Promise=function(a){this._promiseTarget=a||g},g.Promise.prototype={resolve:function(){var a,b;return"function"==typeof this._promiseSuccess?(a=this._promiseSuccess.apply(this._promiseTarget,arguments),a instanceof g.Promise?(b=this,a.then(function(){b._promiseChild.resolve.apply(b._promiseChild,arguments)},function(){b._promiseChild.reject.apply(b._promiseChild,arguments)})):this._promiseChild.resolve.apply(this._promiseChild,a),void 0):(this._promiseResolved=arguments,void 0)},reject:function(){var a,b;return"function"==typeof this._promiseError?(a=this._promiseError.apply(this._promiseTarget,arguments),a instanceof g.Promise?(b=this,a.then(function(){b._promiseChild.resolve.apply(b._promiseChild,arguments)},function(){b._promiseChild.reject.apply(b._promiseChild,arguments)})):this._promiseChild.reject.apply(this._promiseChild,a),void 0):(this._promiseRejected=arguments,void 0)},progress:function(){"function"==typeof this._promiseProgress&&this._promiseProgress.apply(this._promiseTarget,arguments)},then:function(a,b,c){return this._promiseSuccess=a,this._promiseError=b,this._promiseProgress=c,this._promiseChild=new g.Promise(this._promiseTarget),void 0!==this._promiseResolved&&this._promiseChild.resolve.apply(this._promiseChild,this._promiseResolved),void 0!==this._promiseRejected&&this._promiseChild.reject.apply(this._promiseChild,this._promiseRejected),this._promiseChild}},g.all=g.Promise.all=function(){function a(){c++,c===arguments.length&&b.resolve()}var b,c,d;for(b=new g.Promise,c=0,d=0;d<arguments.length;d++)arguments[d].then(a,b.reject);return b},g.chain=g.Promise.chain=function(){var a;return a=arguments,function(){function b(){var e;return c>=a.length?(d.resolve(),void 0):(e=a[c](),c++,e instanceof g.Promise?(e.then(function(){b()}),void 0):(b(),void 0))}var c,d;return c=0,d=new g.Promise,b(),d}},g.parallel=g.Promise.parallel=function(){var a;return a=arguments,function(){function b(){return e--,0===e?(f.resolve(),void 0):void 0}function c(){var e;d>=a.length||(e=a[d](),d++,e instanceof g.Promise?e.then(b):b(),c())}var d,e,f;return d=0,f=new g.Promise,e=a.length,c(),f}},g.wait=g.Promise.wait=function(a){return function(){var b,c,d,e;return b=new g.Promise,d=lastRunTime,e=d+a,c={finished:!1,update:function(f){void 0===d&&(d=f,e=d+a),f>=e&&(c.finished=!0,b.resolve())}},h.push(c),b}},g.m={},g.moduleFolder="lib/game/",g.defineModule=function(a,b){g.m[a]="function"==typeof b?b():b,g.m[a]instanceof g.Promise&&g.m[a].then(function(b,c){g.m[a]=c})},g.fetchModules=function(a){function b(){h++,h===f.length&&e.resolve()}function c(){e.reject()}var d,e,f,h,i;e=new g.Promise,f=[],h=0,"string"==typeof a&&(a=[a]);for(d in a)void 0===g.m[a[d]]&&f.push(g.moduleFolder+a[d]+".js");if(f.length)for(d in f)i=document.createElement("script"),i.onload=b,i.onerror=c,document.head.appendChild(i),i.src=f[d],f[d]=i;else e.resolve();return e},g.a={},g.assetFolder="lib/assets/",g.getJSON=function(a){var b,c;return b=new g.Promise,c=new XMLHttpRequest,c.onload=function(){var a;try{a=JSON.parse(c.responseText),b.resolve(a)}catch(d){b.reject(d)}},c.onerror=b.reject,c.open("get",a,!0),c.send(),b},g.fetchAssets=function(a){function b(){var a,b;return a=this.src.match(j),a&&(g.a[this.assetKey]=new g.SpriteMap(g.a[this.assetKey],parseInt(a[1],10),parseInt(a[2],10)),h++,h===f.length&&d.resolve()),(a=this.src.match(k))?(a=this.src.split("."),a.pop(),a=a.join(".")+".json",b=this,g.getJSON(a).then(function(a){g.a[b.assetKey]=new g.SpriteAtlas(g.a[b.assetKey],a),h++,h===f.length&&d.resolve()}),void 0):(h++,h===f.length&&d.resolve(),void 0)}function c(){d.reject()}var d,e,f,h,i,j,k;if(d=new g.Promise,f=[],h=0,j=/\.smap\.(\d+)x(\d+)\./,k=/\.atlas\./,"string"==typeof a){if(".json"===a.substr(-5))return g.getJSON(g.assetFolder+a).then(g.fetchAssets).then(function(){d.resolve()},function(){d.reject()}),d;a=[a]}for(e=0;e<a.length;e++)a[e]=a[e].split(":"),2!==a[e].length&&a[e].unshift(a[e][0].split(".").shift()),void 0===g.a[a[e][0]]&&(i=new Image,i.onload=b,i.onerror=c,i.assetKey=a[e][0],g.a[a[e][0]]=i,f.push(a[e]));if(f.length)for(e=0;e<f.length;e++)g.a[f[e][0]].src=g.assetFolder+f[e][1];else d.resolve();return d},g.SpriteMap=function(){},g.SpriteAtlas=function(){},a.prototype={attach:function(a){a._core=this._core,this.entities.push(a)}},g.layer=[new a],g.Core.prototype.createLayer=function(){var b;return b=new a,b._core=this,this.layer.push(b),b};var h;g.renderDebugObjects=!1,h=[],g.Sprite=function(a){this.x=0,this.y=0,this.w=a.width,this.h=a.height,this.originX=0,this.originY=0,this.rotation=0,this.direction=0,this._directionCache=null,this.speed=0,this.scaleX=1,this.scaleY=1,this.alpha=1,this.stretch=!1,this.asset=a,this.debugDrawing=!1,this._destroy=!1,this._core=g},g.Sprite.prototype={update:function(){},draw:function(a){var c,d,e,f;if(e=this.originX,f=this.originY,c=this.w,d=this.h,a.save(),a.translate(this.x,this.y),this.speed){for(;this.direction>360;)this.direction-=360;for(;this.direction<0;)this.direction+=360;this._directionCache&&this._directionCache[0]===this.speed&&this._directionCache[1]===this.direction||(this._directionCache=[this.speed,this.direction,b(this.speed,this.direction)]),this.x+=this._directionCache[2][0],this.y+=this._directionCache[2][1]}if(this.rotation){for(;this.rotation>360;)this.rotation-=360;for(;this.rotation<0;)this.rotation+=360;a.rotate(this.rotation*Math.PI/180)}return a.scale(this.scaleX,this.scaleY),this.stretch||c===this.asset.width&&d===this.asset.height?(a.drawImage(this.asset,-e,-f,c,d),this.debugDrawing&&(a.beginPath(),a.strokeStyle="#0ff",a.strokeRect(-e,-f,c,d),a.stroke(),a.fillStyle="#f0f",a.beginPath(),a.arc(0,0,2,0,365),a.fill()),a.restore(),void 0):(this.pattern||(this.pattern=a.createPattern(this.asset,"repeat")),a.fillStyle=this.pattern,a.fillRect(-e,-f,c,d),a.restore(),void 0)},centerOrigin:function(){return this.changeOrigin(this.w/2,this.h/2),this},changeOrigin:function(a,b){var c,d;return c=this.originX,d=this.originY,this.x+=-c+a,this.y+=-d+b,this.originX=a,this.originY=b,this},tween:function(a,b){var c,d,e,f,h,i,j,k,l,m;c=this._core.getLastRuntime(),d=c+b,f=new g.Promise(this),h=this,i={},j={},k=0;for(l in a)this.hasOwnProperty(l)&&("string"!=typeof a[l]?!isNaN(parseFloat(this[l]))&&isFinite(this[l])&&(i[l]=this[l],j[l]=a[l]-this[l],k++):(m=a[l].match(/^([+-])=(\d+)$/),m&&(i[l]=this[l],j[l]="+"===m[1]?parseFloat(m[2]):-parseFloat(m[2]),k++)));return k?(e={finished:!1,update:function(a){var g;void 0===c&&(c=a,d=c+b),g=1-1/((d-c)/(d-a)),g>=1&&(g=1);for(l in i)h[l]=i[l]+j[l]*g;f.progress(g),1===g&&(e.finished=!0,f.resolve())}},this._core.addTween(e),f):(f.reject(),f)},prepareTween:function(a,b){var c;return c=this,function(){return c.tween(a,b)}},destroy:function(){this._destroy=!0}},g.Group=function(){this.x=0,this.y=0,this.rotation=0,this.alpha=1,this.scaleX=1,this.scaleY=1,this.entities=[],this.debugDrawing=!1,this._destroy=!1,this._core=g},g.Group.prototype={update:function(){},getBoundaries:function(){var a,b,c,d,e,f,h;if(a=Number.POSITIVE_INFINITY,b=Number.POSITIVE_INFINITY,c=0,d=0,!this.entities.length)return{x:this.x,y:this.y,w:0,h:0};for(f=this.entities.length-1,e=f+1;e--;)h=this.entities[f-e],h instanceof g.Sprite?void 0!==h.originX?(a=Math.min(a,h.x-h.originX),b=Math.min(b,h.y-h.originY),c=Math.max(c,h.x+h.w-h.originX),d=Math.max(d,h.y+h.h-h.originY)):(a=Math.min(a,h.x),b=Math.min(b,h.y),c=Math.max(c,h.x+h.w),d=Math.max(d,h.y+h.h)):h instanceof g.Group&&(h=h.getBoundaries(),a=Math.min(a,this.x-h.x),b=Math.min(b,this.y-h.y),c=Math.max(c,h.w),d=Math.max(d,h.h));return c-=a,d-=b,{x:a,y:b,w:c,h:d}},attach:function(a){this.entities.push(a)},draw:function(a){var b,c,d,e;for(a.save(),a.translate(this.x,this.y),a.rotate(this.rotation*Math.PI/360),a.scale(this.scaleX,this.scaleY),b=a.globalAlpha,d=this.entities.length-1,c=d+1;c--;)e=this.entities[d-c],e._destroy?(l.entities.splice(d-c,1),d--):(a.globalAlpha=b*e.alpha,e.update(),e.draw(a));if(this.debugDrawing){var f;f=this.getBoundaries(),a.beginPath(),a.strokeStyle="#0f0",a.strokeRect(f.x,f.y,f.w,f.h),a.stroke(),a.fillStyle="#ff0",a.beginPath(),a.arc(0,0,2,0,365),a.fill()}a.restore()},changeOrigin:function(a,b){var c,d,e,f;c=this.x,d=this.y;for(e in this.entities)f=this.entities[e],f.x-=-c+a,f.y-=-d+b;return this.x=a,this.y=b,this},destroy:function(){this._destroy=!0}},g.Group.prototype.tween=g.Sprite.prototype.tween,g.Group.prototype.prepareTween=g.Sprite.prototype.prepareTween,g.Label=function(){this.x=0,this.y=0,this.w=0,this.h=0,this.originX=0,this.originY=0,this.rotation=0,this.alpha=1,this.scaleX=1,this.scaleY=1,this.debugDrawing=!1,this._destroy=!1,this.font="Arial",this.size=12,this.style="",this.color="#000",this.strokeColor="#000",this.strokeWidth=0,this.strokeOver=!1,this.align="left",this.verticalAlign="top",this._measureCache=null},g.Label.prototype={update:function(){},draw:function(a){var b;if(a.save(),a.translate(this.x,this.y),this.rotation&&a.rotate(this.rotation*Math.PI/180),a.scale(this.scaleX,this.scaleY),a.font=this.size+'px "'+this.font+'" '+this.style,a.fillStyle=this.color,a.strokeStyle=this.strokeColor,a.lineWidth=this.strokeWidth,a.textAlign=this.align,a.textBaseline=this.verticalAlign,b=a.font+a.lineWidth+a.textAlign+a.textBaseline,this._measureCache!==b&&(this._measureCache=b,this.calculateDimensions(),this._asyncCenter&&(delete this._asyncCenter,this.centerOrigin())),this.strokeOver?(a.fillText(this.value,-this.originX,-this.originY),this.strokeWidth&&a.strokeText(this.value,-this.originX,-this.originY)):(this.strokeWidth&&a.strokeText(this.value,-this.originX,-this.originY),a.fillText(this.value,-this.originX,-this.originY)),this.debugDrawing){switch(a.beginPath(),a.strokeStyle="#0ff",a.lineWidth=1,this.align){case"right":a.strokeRect(-this.originX-this.w,-this.originY,this.w,this.h);break;case"center":a.strokeRect(-this.originX,-this.originY,this.w,this.h);break;case"left":a.strokeRect(-this.originX+this.w,-this.originY,this.w,this.h)}a.stroke(),a.fillStyle="#f0f",a.beginPath(),a.arc(0,0,2,0,365),a.fill()}a.restore()},centerOrigin:function(){return null===this._measureCache?(this._asyncCenter=!0,void 0):(console.log(this),this.changeOrigin(this.w/2,this.h/2),void 0)},calculateDimensions:function(a){var b;a||(b=document.createElement("canvas"),a=b.getContext("2d")),a.save(),a.font=this.size+'px "'+this.font+'" '+this.style,a.fillStyle=this.color,a.strokeStyle=this.strokeColor,a.lineWidth=this.strokeWidth,a.textAlign=this.align,a.textBaseline=this.verticalAlign,this.w=a.measureText(this.value).width,b=document.createElement("span"),b.style.fontFamily=this.font,b.style.fontStyle=this.style,b.style.verticalAlign=this.verticalAlign,b.style.fontSize=this.size+"px",b.style.padding=0,b.style.margin=0,b.innerHTML=this.value,document.body.appendChild(b),this.h=b.offsetHeight,document.body.removeChild(b),a.restore()}},g.Label.prototype.tween=g.Sprite.prototype.tween,g.Label.prototype.prepareTween=g.Sprite.prototype.prepareTween,g.Label.prototype.changeOrigin=g.Sprite.prototype.changeOrigin,g.Label.prototype.destroy=g.Sprite.prototype.destroy;var i,j,k,m,n,o;n={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"win",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:";",187:"+",188:",",189:"-",190:".",191:"/",192:"`",219:"(",220:"^",221:"Â´",222:"`",226:"\\"};var p,q,r;g.PointerArea=function(){d(),this.x=0,this.y=0,this.w=g.width(),this.h=g.height(),this.originX=0,this.originY=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this._attachedEvents={},this.debugDrawing=!1,this.disabled=!1},g.PointerArea.prototype={draw:function(a){this.debugDrawing&&(a.save(),a.translate(this.x,this.y),this.rotation&&a.rotate(this.rotation*Math.PI/180),a.scale(this.scaleX,this.scaleY),a.beginPath(),a.strokeStyle="#fff",a.stroke(),a.restore())},shadowDraw:function(a,b,c){if(!(this instanceof g.Sprite&&void 0===this.disabled||this instanceof g.PointerArea&&void 0===this._attachedEvents[c])){var d;if(o.save(),o.translate(this.x,this.y),this.rotation&&o.rotate(this.rotation*Math.PI/180),o.scale(this.scaleX,this.scaleY),this instanceof g.Sprite&&!this._captureBoundingBox&&(o.drawImage(this.asset,-this.originX,-this.originY),f(a,b)))for(d in this._attachedEvents[c])this._attachedEvents[c][d].resolve(a,b);if((this instanceof g.PointerArea||this._captureBoundingBox)&&(o.beginPath(),o.fillRect(-this.originX,-this.originY,this.w,this.h),o.fill(),f(a,b)))for(d in this._attachedEvents[c])this._attachedEvents[c][d].resolve(a,b);if(this instanceof g.Group)for(d in this.entities)this.entities[d].shadowDraw(a,b,c);o.restore()}},on:function(a){void 0===this._attachedEvents[a]&&(this._attachedEvents[a]=[]);var b;switch(b=new g.Promise,a){case"pointerdown":p=!0;break;case"pointerup":q=!0;break;case"pointermove":r=!0}return this._attachedEvents[a].push(b),b}},g.Sprite.prototype.shadowDraw=g.PointerArea.prototype.shadowDraw,g.Group.prototype.shadowDraw=g.PointerArea.prototype.shadowDraw,g.Sprite.prototype.pointerEnable=function(a){d(this._core),this._captureBoundingBox=a,this._attachedEvents={},this.disabled=!1,this.on=g.PointerArea.prototype.on},g.onKey=function(a){var b;return c(),b=new g.Promise,void 0===k[a]&&(k[a]=[]),k[a].push(b),b},g.limitCalls=function(a,b){var c;return c=0,function(){Date.now()<c+b||(c=Date.now(),a.apply(this,arguments))}},g.clone=function(a){if(null===a||"object"!=typeof a)return a;var b,c,d,e;for(a instanceof g.Sprite&&(b=new g.Sprite(a.asset)),a instanceof g.Group&&(b=new g.Group),void 0===b&&(b={}),c=Object.keys(a),d=0;d<c.length;d++)e=a[c[d]],b[c[d]]=e instanceof g.Group||e instanceof g.Sprite?g.clone(e):e;return b},g.Timer=function(a,b){var c,d,e;return b||(b=g),c=new g.Promise,c.interval=a,d={finished:!1,update:function(a){return e?(e+c.interval<a&&(e=a,c.resolve()),void 0):(e=a,void 0)}},c.disable=function(){d.finished=!0},c.enable=function(){d.finished=!1,b.addTween(d)},c.enable(),c},g.randomSeed=function(){return Math.floor(99999*Math.random())+1}(),g.random=function(){var a=1e4*Math.abs(Math.sin(g.randomSeed++));return a-~~a},g.randomInRange=function(a,b){return g.random()*(b-a)+a},g.extend=function(a){var b,c,d=1;if(1===arguments.length)return a;for(;d<arguments.length;d++)if(b=arguments[d])for(c in b)a[c]=b[c];return a},g.extend(g,new g.Core),setTimeout(function(){g.fetchModules("main")},0)}();