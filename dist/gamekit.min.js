/* Gamekit
 * =======
 * @license: CC BY-NC 3.0 (http://creativecommons.org/licenses/by-nc/3.0/)
 * @license: Request commercial licenses from hello@wearekiss.com
 * @author: Christian Engel <hello@wearekiss.com>
 * @updated: Mon Aug 26 2013
 */
!function(){"use strict";function a(){this.entities=[],this.visible=!0,this.alpha=1}function b(a){var d,e,f,g,i,r;if(k){for(window.requestAnimationFrame(b),l=a,h.onBeforeFrame(j),(o||p)&&c.clearRect(m,n,o,p),d=q.length;d--;)e=q[d],e.finished?q.splice(d,1):e.update(a);for(i=h.layer.length-1,d=i+1;d--;)if(g=h.layer[i-d],g.visible&&g.alpha)for(r=g.entities.length-1,e=r+1;e--;)f=g.entities[r-e],j.globalAlpha=f.alpha*g.alpha,f.update(),f.draw(j);h.onAfterFrame(j)}}function d(){r||(t={},window.onkeydown=function(a){var b,c;if(b=u[a.keyCode],b&&void 0!==t[b])for(c in t[b])t[b][c].resolve()},r=!0)}function e(){var a;s||(s=!0,a=document.createElement("canvas"),a.width=i.width,a.height=i.height,v=a.getContext("2d"),v.globalCompositeOperation="copy",v.fillStyle="#f00",i.onmousedown=function(a){w&&f(a,"pointerdown")},i.onmouseup=function(a){x&&f(a,"pointerup")},i.onmousemove=function(a){y&&f(a,"pointermove")},i.ontouchstart=function(a){w&&f(a,"pointerdown")},i.ontouchend=function(a){x&&f(a,"pointerdown")},i.ontouchmove=function(a){y&&f(a,"pointermove")})}function f(a,b){var c,d,e,f,g,j,l;if(c=a.clientX-i.offsetLeft+window.scrollX,d=a.clientY-i.offsetTop+window.scrollY,k)for(e=h.layer.length-1,l=e+1;l--;)if(f=h.layer[e-l],f.visible)for(g=f.entities.length-1,j=g+1;j--;)a=f.entities[g-j],a.disabled||a.shadowDraw(c,d,b)}function g(a,b){var c;return c=v.getImageData(a,b,1,1).data,c[0]||c[1]||c[2]||c[3]?!0:!1}var h,i,j;i=document.getElementsByTagName("canvas")[0],j=i.getContext("2d"),function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),window.gamekit=h={},h.Promise=function(a){this._promiseTarget=a||h},h.Promise.prototype={resolve:function(){var a,b;return"function"==typeof this._promiseSuccess?(a=this._promiseSuccess.apply(this._promiseTarget,arguments),a instanceof h.Promise?(b=this,a.then(function(){b._promiseChild.resolve.apply(b._promiseChild,arguments)},function(){b._promiseChild.reject.apply(b._promiseChild,arguments)})):this._promiseChild.resolve.apply(this._promiseChild,a),void 0):(this._promiseResolved=arguments,void 0)},reject:function(){var a,b;return"function"==typeof this._promiseError?(a=this._promiseError.apply(this._promiseTarget,arguments),a instanceof h.Promise?(b=this,a.then(function(){b._promiseChild.resolve.apply(b._promiseChild,arguments)},function(){b._promiseChild.reject.apply(b._promiseChild,arguments)})):this._promiseChild.reject.apply(this._promiseChild,a),void 0):(this._promiseRejected=arguments,void 0)},then:function(a,b){return this._promiseSuccess=a,this._promiseError=b,this._promiseChild=new h.Promise(this._promiseTarget),void 0!==this._promiseResolved&&this._promiseChild.resolve.apply(this._promiseChild,this._promiseResolved),void 0!==this._promiseRejected&&this._promiseChild.reject.apply(this._promiseChild,this._promiseRejected),this._promiseChild}},h.all=function(){function a(){c++,c===arguments.length&&b.resolve()}var b,c,d;for(b=new h.Promise,c=0,d=0;d<arguments.length;d++)arguments[d].then(a,b.reject);return b},h.chain=function(){var a;return a=arguments,function(){function b(){var e;return c>=a.length?(d.resolve(),void 0):(e=a[c](),c++,e instanceof h.Promise?(e.then(function(){b()}),void 0):(b(),void 0))}var c,d;return c=0,d=new h.Promise,b(),d}},h.parallel=function(){var a;return a=arguments,function(){function b(){return e--,0===e?(f.resolve(),void 0):void 0}function c(){var e;d>=a.length||(e=a[d](),d++,e instanceof h.Promise?e.then(b):b(),c())}var d,e,f;return d=0,f=new h.Promise,e=a.length,c(),f}},h.wait=function(a){return function(){var b,c,d,e;return b=new h.Promise,d=l,e=d+a,c={finished:!1,update:function(f){void 0===d&&(d=f,e=d+a),f>=e&&(c.finished=!0,b.resolve())}},q.push(c),b}},h.m={},h.moduleFolder="lib/game/",h.defineModule=function(a,b){h.m[a]=b()},h.fetchModules=function(a){function b(){g++,g===f.length&&e.resolve()}function c(){e.reject()}var d,e,f,g,i;e=new h.Promise,f=[],g=0,"string"==typeof a&&(a=[a]);for(d in a)void 0===h.m[a[d]]&&f.push(h.moduleFolder+a[d]+".js");if(f.length)for(d in f)i=document.createElement("script"),i.onload=b,i.onerror=c,document.head.appendChild(i),i.src=f[d],f[d]=i;else e.resolve();return e},h.a={},h.assetFolder="lib/assets/",h.getJSON=function(a){var b,c;return b=new h.Promise,c=new XMLHttpRequest,c.onload=function(){var a;try{a=JSON.parse(c.responseText),b.resolve(a)}catch(d){b.reject(d)}},c.onerror=b.reject,c.open("get",a,!0),c.send(),b},h.fetchAssets=function(a){function b(){var a,b;return a=this.src.match(j),a&&(h.a[this.assetKey]=new h.SpriteMap(h.a[this.assetKey],parseInt(a[1],10),parseInt(a[2],10)),g++,g===f.length&&d.resolve()),(a=this.src.match(k))?(a=this.src.split("."),a.pop(),a=a.join(".")+".json",b=this,h.getJSON(a).then(function(a){h.a[b.assetKey]=new h.SpriteAtlas(h.a[b.assetKey],a),g++,g===f.length&&d.resolve()}),void 0):(g++,g===f.length&&d.resolve(),void 0)}function c(){d.reject()}var d,e,f,g,i,j,k;if(d=new h.Promise,f=[],g=0,j=/\.smap\.(\d+)x(\d+)\./,k=/\.atlas\./,"string"==typeof a){if(".json"===a.substr(-5))return h.getJSON(h.assetFolder+a).then(h.fetchAssets).then(function(){d.resolve()},function(){d.reject()}),d;a=[a]}for(e in a){if(a[e]=a[e].split(":"),2!==a[e].length)return d.reject(),d;void 0===h.a[a[e][0]]&&(i=new Image,i.onload=b,i.onerror=c,i.assetKey=a[e][0],h.a[a[e][0]]=i,f.push(a[e]))}if(f.length)for(e in f)h.a[f[e][0]].src=h.assetFolder+f[e][1];else d.resolve();return d},h.SpriteMap=function(){},h.SpriteAtlas=function(){},a.prototype={attach:function(a){this.entities.push(a)}},h.layer=[new a],h.createLayer=function(){var b;return b=new a,h.layer.push(b),b};var k,l;h.start=function(){k=!0,window.requestAnimationFrame(b)},h.stop=function(){k=!1},h.width=function(){return i.width},h.height=function(){return i.height},h.onBeforeFrame=function(){},h.onAfterFrame=function(){};var m,n,o,p;h.clearCanvas=function(a,b,c,d){m=a||0,n=b||0,o=c||h.width(),p=d||h.height()};var q;h.renderDebugObjects=!1,q=[],h.Sprite=function(a){this.x=0,this.y=0,this.w=a.width,this.h=a.height,this.originX=0,this.originY=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.alpha=1,this.stretch=!1,this.asset=a,this.debugDrawing=!1},h.Sprite.prototype={update:function(){},draw:function(a){var b,c,d,e;return d=this.originX,e=this.originY,b=this.w,c=this.h,a.save(),a.translate(this.x,this.y),this.rotation&&a.rotate(this.rotation*Math.PI/180),a.scale(this.scaleX,this.scaleY),this.stretch||b===this.asset.width&&c===this.asset.height?(a.drawImage(this.asset,-d,-e,b,c),this.debugDrawing&&(a.beginPath(),a.strokeStyle="#0ff",a.strokeRect(-d,-e,b,c),a.stroke(),a.fillStyle="#f0f",a.beginPath(),a.arc(0,0,2,0,365),a.fill()),a.restore(),void 0):(this.pattern||(this.pattern=a.createPattern(this.asset,"repeat")),a.fillStyle=this.pattern,a.fillRect(-d,-e,b,c),a.restore(),void 0)},centerOrigin:function(){return this.changeOrigin(this.w/2,this.h/2),this},changeOrigin:function(a,b){var c,d;return c=this.originX,d=this.originY,this.x+=-c+a,this.y+=-d+b,this.originX=a,this.originY=b,this},tween:function(a,b){var c,d,e,f,g,i,j,k,m,n;c=l,d=c+b,f=new h.Promise,g=this,i={},j={},k=0;for(m in a)this.hasOwnProperty(m)&&("string"!=typeof a[m]?!isNaN(parseFloat(this[m]))&&isFinite(this[m])&&(i[m]=this[m],j[m]=a[m]-this[m],k++):(n=a[m].match(/^([+-])=(\d+)$/),n&&(i[m]=this[m],j[m]="+"===n[1]?parseFloat(n[2]):-parseFloat(n[2]),k++)));return k?(e={finished:!1,update:function(a){var h;void 0===c&&(c=a,d=c+b),h=1-1/((d-c)/(d-a)),h>=1&&(h=1);for(m in i)g[m]=i[m]+j[m]*h;1===h&&(e.finished=!0,f.resolve())}},q.push(e),f):(f.reject(),f)},prepareTween:function(a,b){var c;return c=this,function(){return c.tween(a,b)}}},h.Group=function(){this.x=0,this.y=0,this.rotation=0,this.alpha=1,this.scaleX=1,this.scaleY=1,this.entities=[],this.debugDrawing=!1},h.Group.prototype={update:function(){},getBoundaries:function(){var a,b,c,d,e,f;if(a=Number.POSITIVE_INFINITY,b=Number.POSITIVE_INFINITY,c=0,d=0,!this.entities.length)return{x:this.x,y:this.y,w:0,h:0};for(e in this.entities)f=this.entities[e],void 0!==f.originX?(a=Math.min(a,f.x-f.originX),b=Math.min(b,f.y-f.originY),c=Math.max(c,f.x+f.w-f.originX),d=Math.max(d,f.y+f.h-f.originY)):(a=Math.min(a,f.x),b=Math.min(b,f.y),c=Math.max(c,f.x+f.w),d=Math.max(d,f.y+f.h));return c-=a,d-=b,{x:a,y:b,w:c,h:d}},attach:function(a){this.entities.push(a)},draw:function(a){var b,c,d;a.save(),a.translate(this.x,this.y),a.rotate(this.rotation*Math.PI/360),a.scale(this.scaleX,this.scaleY),b=a.globalAlpha;for(c in this.entities)d=this.entities[c],a.globalAlpha=b*d.alpha,d.update(),d.draw(a);if(this.debugDrawing){var e;e=this.getBoundaries(),a.beginPath(),a.strokeStyle="#0f0",a.strokeRect(e.x,e.y,e.w,e.h),a.stroke(),a.fillStyle="#ff0",a.beginPath(),a.arc(0,0,2,0,365),a.fill()}a.restore()},changeOrigin:function(a,b){var c,d,e,f;c=this.x,d=this.y;for(e in this.entities)f=this.entities[e],f.x-=-c+a,f.y-=-d+b;return this.x=a,this.y=b,this}},h.Group.prototype.tween=h.Sprite.prototype.tween,h.Group.prototype.prepareTween=h.Sprite.prototype.prepareTween;var r,s,t,u,v;u={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"win",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:";",187:"+",188:",",189:"-",190:".",191:"/",192:"`",219:"(",220:"^",221:"Â´",222:"`",226:"\\"};var w,x,y;h.PointerArea=function(){e(),this.x=0,this.y=0,this.w=h.width(),this.h=h.height(),this.originX=0,this.originY=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this._attachedEvents={},this.debugDrawing=!1,this.disabled=!1},h.PointerArea.prototype={draw:function(a){this.debugDrawing&&(a.save(),a.translate(this.x,this.y),this.rotation&&a.rotate(this.rotation*Math.PI/180),a.scale(this.scaleX,this.scaleY),a.beginPath(),a.strokeStyle="#fff",a.stroke(),a.restore())},shadowDraw:function(a,b,c){if(!(this instanceof h.Sprite&&void 0===this.disabled||this instanceof h.PointerArea&&void 0===this._attachedEvents[c])){var d;if(v.save(),v.translate(this.x,this.y),this.rotation&&v.rotate(this.rotation*Math.PI/180),v.scale(this.scaleX,this.scaleY),this instanceof h.Sprite&&!this._captureBoundingBox&&(v.drawImage(this.asset,-this.originX,-this.originY),g(a,b)))for(d in this._attachedEvents[c])this._attachedEvents[c][d].resolve(a,b);if((this instanceof h.PointerArea||this._captureBoundingBox)&&(v.beginPath(),v.fillRect(-this.originX,-this.originY,this.w,this.h),v.fill(),g(a,b)))for(d in this._attachedEvents[c])this._attachedEvents[c][d].resolve(a,b);if(this instanceof h.Group)for(d in this.entities)this.entities[d].shadowDraw(a,b,c);v.restore()}},on:function(a){void 0===this._attachedEvents[a]&&(this._attachedEvents[a]=[]);var b;switch(b=new h.Promise,a){case"pointerdown":w=!0;break;case"pointerup":x=!0;break;case"pointermove":y=!0}return this._attachedEvents[a].push(b),b}},h.Sprite.prototype.shadowDraw=h.PointerArea.prototype.shadowDraw,h.Group.prototype.shadowDraw=h.PointerArea.prototype.shadowDraw,h.Sprite.prototype.pointerEnable=function(a){e(),this._captureBoundingBox=a,this._attachedEvents={},this.disabled=!1,this.on=h.PointerArea.prototype.on},h.input={onKey:function(a){var b;return d(),b=new h.Promise,void 0===t[a]&&(t[a]=[]),t[a].push(b),b}},h.limitCalls=function(a,b){var c;return c=0,function(){Date.now()<c+b||(c=Date.now(),a.apply(this,arguments))}},h.clone=function(a){if(null===a||"object"!=typeof a)return a;var b,c,d,e;for(a instanceof h.Sprite&&(b=new h.Sprite(a.asset)),a instanceof h.Group&&(b=new h.Group),void 0===b&&(b={}),c=Object.keys(a),d=0;d<c.length;d++)e=a[c[d]],b[c[d]]=e instanceof h.Group||e instanceof h.Sprite?h.clone(e):e;return b},setTimeout(function(){h.fetchModules("main")},0)}();